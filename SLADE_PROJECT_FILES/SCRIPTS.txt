#library "mymod"
#include "zcommon.acs"

#define MAX_PLAYERS 8
#define HUD_BOARD_ID 7777
#define HUD_TEXT_ID  7778

// compile with the following
// D:\Desktop\doomChess>"D:\Desktop\doomChess\acc-1.60-win32\acc.exe" SCRIPTS.acs doomChess.o

// Per-player state
int curPuzzle[MAX_PLAYERS];          // -1 = none selected
int chess_board_showing[MAX_PLAYERS]; // 0/1
int lastDmgTic[MAX_PLAYERS];  // per-player cooldown

// --- DB ---
str BoardImg[496] = { "71ugD", "iROHJ", "Yh2o9", "tXZFG", "8yDcF", "BW017", "9lplG", "l2pVg", "Rq3UW", "xZZTl", "4qukz", "7JmfE", "3UttM", "qCzv5", "FZWDD", "YqYIu", "OwHp6", "yjpZ8", "Cu7Uo", "yZA6P", "wvuKU", "l1DYQ", "gEec4", "qDqqW", "uAIZH", "zeIUG", "DOjac", "3L3Gn", "4hLUf", "k6NMJ", "skZMc", "HOTvt", "CApou", "E60ky", "p6JWP", "DHre7", "kCL3i", "3JW9E", "RCP7F", "PQDlK", "6FWSm", "ZXvRl", "FxtSD", "veQSv", "aocFM", "wwWur", "BRISw", "geo9z", "FbZhE", "ERqPC", "41Oot", "nMkx7", "zhCR9", "2Uqoz", "Dfrxx", "xuWti", "904AL", "nPDt4", "RpVAu", "oVBxN", "XQBnH", "PEzXs", "gdoka", "NhO4K", "Uno5s", "Cilp1", "JKASo", "2lK0s", "4zc3G", "y32nE", "tfs3k", "kXEmE", "j2nug", "lNUKr", "9bmx0", "CdTMW", "EZGel", "cyQm4", "Sz7be", "0Qb0A", "unG5n", "CA44u", "94FmZ", "2lex4", "AEVN5", "Z9UxH", "Iyt3O", "vEk8W", "ff7Ax", "8v8aj", "RdoRx", "YpGQn", "Hj1pW", "agX93", "QKdLr", "uckr2", "B7sUx", "BIfZ6", "m1Jmp", "tYv2x", "jvMum", "cQSum", "IMky5", "FO8fu", "O8q6B", "4DfOy", "Sd1Qv", "yDzqD", "bwOEU", "FShmv", "yPFYf", "VmO4l", "szMwC", "Iy0CM", "5asab", "ThUrG", "iIzfa", "ETugg", "PZQ6c", "b49ax", "fgxUe", "vbCN2", "ZeZnI", "L8m5C", "qfxoG", "0iYar", "p4TLe", "Sn7ZI", "1M0Vp", "wBYIp", "zy2kJ", "OJ5DL", "5G4X9", "2DAxo", "eZaXT", "AnTTx", "bhRhY", "Ub1X2", "tSGJc", "vIOYE", "KmjW6", "RzXO0", "jysYO", "lCJJx", "n9u9o", "XXXmA", "QTlJ3", "kHe0T", "bum6C", "sidXR", "v2O5A", "g0SLF", "OCAFB", "fZzD7", "K2Z83", "seEgj", "H80u7", "NsDkm", "19qNI", "K2GMj", "0ESwo", "bvEcj", "2knIc", "ynh3y", "OTqSw", "jzzOr", "nGr9G", "foYvJ", "tUSeD", "tGaqF", "eLHQz", "ODL3s", "yaLQH", "etk5a", "VID7l", "XiLsQ", "sohKb", "tvQPr", "4RnVT", "QtFcQ", "2VH6h", "r0dnA", "NFbyh", "N8YDf", "h3uOK", "pJgvK", "kzf4T", "xqCC2", "f376Z", "BUgK9", "9JZwp", "JYltQ", "vps3W", "fN3Qr", "gGDK7", "HfEvZ", "mTh6I", "EtnNG", "8n0dz", "rRyjq", "OceDn", "ZAQ6g", "Ursez", "d3EDF", "Tx3TB", "TU0p0", "kAvCN", "mTclJ", "0kKyi", "XFm2P", "6I9Mf", "ywYtm", "kZ8Aj", "ygcyK", "KWAZJ", "n5CS1", "aJ9zr", "z6u6o", "1iab2", "hhWzW", "o3zHF", "oQaMH", "wGFXn", "uRDfZ", "g1Cif", "PQ4ML", "2cnZq", "Gp3Vt", "kGRUy", "Jvc6R", "ebpkD", "GvxN0", "KDmOS", "4DFQi", "xsSoh", "cUeKT", "QNjgm", "ZtdOI", "sipxz", "RgXHw", "fzGZg", "SdwOu", "Vh3Sy", "KftHu", "qdgU0", "RelGA", "3wf4G", "npCNU", "MYd7X", "XIceB", "joXZx", "0Ozpn", "QbcDa", "wJ7Vy", "0VmFi", "N5sd7", "avkJm", "wln5d", "KcUE2", "ZJPSc", "p0XU1", "T8lhc", "wmG22", "z0xkH", "KxoIs", "tkklS", "e2Cr6", "TNOPL", "z9bqZ", "6zgHm", "dLMBz", "IraUB", "jsc1A", "SXDB0", "NSgIi", "yWtZV", "3Y0Uu", "bYae9", "xDDy5", "Y7dzf", "aijno", "knVh5", "w5YsW", "tI9xf", "rbsec", "b7Ydb", "HwMot", "sDITi", "XdoI3", "pDKm4", "lDXoo", "x5gD3", "1RyZB", "srks5", "ShDSU", "gbfw6", "g61dB", "g8dwx", "6ukH6", "UaW1V", "7KuFT", "8OJXt", "DnJIc", "X50lT", "6gKW9", "LyGca", "9hgBp", "KMUie", "j2D9b", "P4mbG", "1WDx2", "8QDbj", "ZvSKl", "rJj5y", "YY1nS", "ircWp", "9slxR", "HXsDl", "L7FEe", "u4cED", "YzcWe", "BEC0q", "aoaD3", "CjqVQ", "vi9mt", "DoL0i", "A0Zec", "JRfkQ", "rhtfL", "5AqS0", "JcZsw", "MXj96", "vcn3f", "8AJRv", "C9keM", "HHkfn", "coyzR", "6CAy6", "zrf0i", "RkjvE", "lY7dJ", "l4Xn9", "1oOYK", "GicJd", "75kAX", "Rk4Z2", "4eghP", "af9QJ", "z9w3Y", "ZLzug", "cpEZw", "6U4vj", "uqBB5", "g2uNF", "haSEa", "P8gLd", "N4ZXd", "X371I", "u6nug", "JWwC0", "2YVEC", "rN8oB", "y2hRN", "HHYwy", "ZP3LS", "lFum3", "3raXu", "c6etn", "uVB1C", "bqZm9", "uNgmh", "5atBt", "ux9nY", "Ce64x", "U2y6K", "LPOxN", "EL9cn", "HDpi9", "WKcQN", "e3qvZ", "1Ty0f", "sZ6l5", "yY8Ke", "P2ThK", "6uNJl", "j1qEf", "QP22l", "7XNXF", "WqP94", "3RudL", "mXSKj", "5sQ4e", "yJQrr", "H6EWl", "YMuSG", "jFesk", "wk0gn", "4vYyg", "HGpJh", "6GcBO", "kOWFi", "E5NLG", "19KAE", "YyFS4", "H8CLs", "yRenO", "7i6TX", "pIrx1", "B33wS", "SiLQa", "o287Y", "H3HKF", "qSYCO", "ga1aq", "XVdbU", "f7ZKe", "EKOwQ", "XYLLO", "MkPMh", "AILDx", "RfZ8k", "dGosZ", "h3eid", "6aYX9", "Ogfjf", "mIjrE", "vxsUn", "CMdsj", "T6Yzz", "FPtw1", "GvdCb", "aGRBb", "pKzks", "sXNy6", "xBxLj", "mpfPv", "iyKLr", "xmOCu", "OlJze", "YFEcQ", "AzLhs", "F2rIx", "iR28h", "ZaQBm", "eyHZE", "n6dzI", "AjH4o", "WrKoE", "oqxJI", "gaH6y", "ORrUz", "mce9y", "1tjUg", "KIP5A", "akAhL", "5kUGM", "91JgD", "8rqu2", "Wxkva", "3bzZq", "KgdMF", "bK6bO", "uaLxK", "6IBh6", "p1NBz", "bvjDE", "M2A0c", "4uBZC", "QIlkF", "oz8mg", "G3n0H", "jgNfk", "1K5kE", "1DfYU", "9Ouq9", "fr9Gf", "LtrHA", "rXfAU", "VKIZ2", "D26Ww", "obtdo", "G0JL6", "l4J4p", "wqVdy", "FThC2", "gHxt4", "Vw414", "SMybh", "V5Tyw", "iw6bf", "wFTRu", "OSXHI", "ZLyyu", "ZmUgw", "CRwX3", "IT5zt" };
str Opt1[496] = { "Bh6", "Bf4", "Qxg7#", "...Nh6#", "Qh7#", "...Ng3+", "Qxf6", "...Qxd6", "...f5", "Nf6+", "...Qc7", "...Bh6", "g4", "Nf3+", "...Bc6", "Rd8+", "...Re1+", "Kc2", "...Ba6", "...Ne2+", "...Qxb4+", "...Rhc2#", "Qxg7+", "...Qc7", "...Qb4", "Rxf8#", "Qh4", "...b5", "Rf7+", "Rh4", "Nf6+", "O-O", "Re4", "Kc2", "Ne4", "gxh5+", "...Qc1+", "Qh6#", "g4", "...Nd6", "...Bxh2+", "...Qe5", "Bc3", "...Re1+", "...Ne3", "...Qb2#", "Nxf4+", "h3", "...Qh1+", "Rg1", "...gxh3", "...Qh6", "Bb2", "...Bxe5", "Kf3", "...f5", "Rxb6", "...Nxf2", "...Ne2+", "...R8c7", "Rad1", "Qe7+", "Rh7", "...Nd5+", "g4+", "Ne7+", "...Qxb3", "b3", "Rxb6+", "...g5+", "Bxe3", "O-O", "Re2", "Kg2", "...Qd3+", "Nxf7", "...Rh5", "Qh6+", "...Rb5", "...Kf4", "...Kb8", "...R1c2+", "...h6", "a4", "Be2", "...Raa8", "...Ke7", "Qc8+", "Kf2", "Qd1", "Rb1", "a5", "d7", "Qe3", "Ke3", "...Kf8", "b4", "...Kg5", "...Qxb2", "...Rd1+", "...Bxc5", "...Kc8", "...Kf6", "...Rc8", "...Qf3", "...Qd3", "g3", "Nxc6", "...Ra8", "Rxh7+", "Qh6+", "...Ree2", "...Bg4+", "Rf8+", "...Rxb2", "Rb4", "...Kxe6", "...f5", "...Rxh6", "...Qe5", "Qa8", "...Nxh1", "...Rg3", "Ra1", "...Rxb2", "Bf4+", "Rc5", "Qf1", "Nd8", "Nf6+", "...Re1", "...Bc5+", "...Qf2#", "Qg3", "Kf2", "...g4", "...Kd8", "Rdg1", "Ra8+", "b7", "Rxc8", "Kh1", "...Qf7+", "Qg1", "...Kb8", "Qf3", "...Qf5+", "axb4", "Rd3", "Rc7", "...Kd4", "Rxd3", "Kf1", "Bb3", "Qe3", "...Ke7", "...e5", "Bxf6", "Ke4", "...Qh3", "...Rxe2", "...Bxa1", "Ra7", "R6a5+", "Nd2", "Qh7#", "...Bg6", "Qxe8", "Bxb7+", "...Qd8", "Kg2", "...Nxf5", "Qxf5", "...Qxg4+", "...Nf5", "...b4", "Na3", "Na3", "Qh5", "...Qxd5", "Rc1", "...Bf8", "...fxg6", "Kf3", "Bd2", "...Rh1", "Rxc4", "Rh5", "...Kg8", "...Rbc8", "...Re6", "...Rb8", "Kg2", "...Rxh2#", "...Qg4", "g3", "Qg1", "...Qxc4", "...Qd6+", "...Qh7", "Nxh6", "Bxf5", "c4+", "...d2", "Ng3", "Rh3+", "...Kb6", "Qc7+", "...Ra2", "...Qg2+", "Bxf6", "Bg3", "Ng5", "Re1", "Rdxf6+", "Rf8#", "...Qb6", "...Kh7", "...g6", "Kd4", "...Kf6", "e4", "Qd4+", "...Qb3+", "...Bb3", "Qf7#", "...Kh7", "g4+", "Qf4", "...Re8", "Qc7+", "Nxf7+", "Qh3", "Qxe4", "...Qxb2#", "...Be5", "...Qe6", "e6", "h5", "d7", "...Re4", "...Rd5", "Bf7", "...h4", "...Rxf4", "...Kf7", "Qb6+", "Qb6", "Bxh7+", "...Rd1+", "...Rh8", "...e5", "Qb2+", "exd7+", "Rh6", "...Qxg2+", "...Re2", "...Bf2", "...Bb4", "Qd2+", "...Bxe4", "Ne5+", "...d5", "...d3", "...Nd5#", "e6", "Rxc5", "Bxe6", "...Re1+", "...Bb8", "Qe1", "...d4", "...Bxh2+", "Rb1", "...Re2", "...Bc5", "Nf4", "Qd8+", "...Qxe5+", "gxf3", "Qh4", "Rxb4", "Nxf7", "...Qc7", "Qh3#", "c4", "...Kd6", "Rxb3", "...Qd8", "...g4", "...Rxf6", "...g4", "...Rxf5", "...Nc6", "...exd4", "Rxg6+", "Rf4", "...Rxf7", "Ra8+", "Qxf7+", "...Rc4", "Ra3", "Ra8#", "a3", "Kf3", "Rxh6", "...Ra4", "...Rxf7", "...Rd2", "...Qxc3", "a4", "...Bh7+", "Be3", "...Rxf2", "...Re8", "...a5", "Rhe1", "...Nxa3", "...Qc6", "...Kd7", "...Re4", "...Rh4", "...Bxd4", "Qxf8#", "...Qh2#", "...Qg3+", "...Qh6", "...Rxd6", "Qc7", "Rxd1", "...Qxd5", "...hxg6", "Qf8+", "...Be6", "Rg3", "Rd1", "Re7+", "Ng5+", "a4", "Kg3", "Nd2", "...Rd4", "Rad1", "Qc5+", "Qxe6+", "Kb7", "...Kf6", "...h5", "...Kh7", "g5", "...Qa1+", "...Qe1+", "Qxf5", "...Nb4", "Bxd4", "Rxe8+", "Nd3", "Qxf8#", "...Rxe3", "Qe4", "...Nc4+", "...Re7", "...Qxf2+", "...Nc6", "Rxd8", "...Qc7", "Bxa6+", "Nb3", "Be2", "...Qxf2+", "...Re8", "Bf1", "Nh7", "...dxc4", "...e4", "Rd8#", "...Qxd4+", "Nc3", "...h5", "Qf1", "...Qxc2#", "...Qd1", "Ne6", "...Rxg2+", "Bc7+", "...Nxf4", "Qc7", "Rg6", "f4", "Ne6+", "...Rxf5", "...Qf2+", "Ka7", "...Rxc5", "...Rb1", "...Nxd4", "Qg4+", "...Qe2#", "...Kb7", "Ke2", "...Kh6", "Qb4", "...Ra1", "...Nb3", "...Qh3+", "Rd7+", "...Qe4+", "Rxf2", "Bd3", "Re7", "Rc7", "...Rf5", "Rh6+", "...Bxh2+", "Bf5", "Qh3", "Bc2", "...Rxf3+", "...Rhf8", "...Neg4+", "...Kxb6", "...Qh2+", "Nc7", "Nxc8", "Qd8+", "Rxh7#", "Qxc6", "Rc8+", "...Rd5", "...Ne5", "...Qxc4#", "...d5", "Ra5", "Qd6+", "Qf5", "Be3", "...Kf7", "...b6", "Rxc3", "...Rd8", "...Nxe2+", "...Qe6", "Rxd3", "...Re1+", "...Rxc2", "Qd1", "fxe4+", "Bb5", "...Rb1#", "Nxd5", "...Rg3+", "Qh4", "...Bd4+", "Qh3", "Kd1", "...Rxf1+", "Rxf8#", "...g5", "Kb6", "...Kd7", "Rxc6+", "...Rh1+", "...Qd7", "...Qb6+", "Rg1", "axb5+", "Rc2", "Bg5", "...Nxd4", "...Bf5", "Qxh7+", "Qd8", "fxe5", "...Rf6", "...Rh3", "...R6c2+", "Re4", "...Rhg6", "...d4+", "...Bb7", "...Qxd4", "...Rg8", "...Rf8", "...Rg2+", "Bd6", "Rxf8#", "Bg6+", "...Bb8+", "...Qg2#", "Rad1", "Qg4", "Re5", "Qxh5+", "Bxd5", "axb5", "...Rxd7" };
str Opt2[496] = { "Qb8+", "Bb5+", "Qh5+", "...Rg5+", "Bxe6", "...Kxd7", "Qxh5", "...Qb8", "...e3", "Rfd1", "...Rc7", "...Nc6", "Qxh6+", "Nc2", "...Ba4", "Rxf4", "...Qg6", "Rh8", "...Bb7", "...Nf3+", "...Ne4", "...Rbc2+", "Qe4", "...Qa5", "...Qe5", "g3", "Rc1", "...Kb3", "Rxe8", "Rxg6#", "Qb3", "Bxg7", "Ree7", "Kc1", "dxc6+", "g5", "...Qxd4+", "Rg1", "Rxd8+", "...b5", "...Be5", "...Qc6", "O-O", "...Bc4", "...Kh7", "...Bxd7", "Ng1", "Ng5#", "...Qf1+", "Kd4", "...g3", "...Qh4", "Ng5", "...f6", "Kg2", "...Rxg2#", "Rxf6", "...Bxf3", "...Nc6", "...e6", "Bxh7+", "Qxh6", "Kc2", "...Ke8", "Qf8", "Na5", "...Qe2", "Rd3", "a4", "...g6", "Qc6+", "Nc3", "Re3", "Kh2", "...Qg5+", "Rxf7+", "...Rc4", "Rf1+", "...Rh1+", "...f2", "...Rxh3+", "...Rd1#", "...Qc3", "Kg1", "d5", "...Nh4", "...Kc6", "Qd7", "Kf3", "Bd2", "Qxd6", "Kb6", "Kh2", "Bxg7", "Kd3", "...Rg3+", "c3", "...Rf1", "...Rd8", "...Rd2", "...h5", "...Qxd6", "...Rxh1", "...Rd8", "...Qd1+", "...Rf1+", "h3", "Nc2", "...e6", "g5", "cxd3", "...Re1#", "...Bd7", "cxb5", "...Rf8+", "Rxb5", "...a4", "...Kd8", "...d2", "...Be5", "Qd1", "...Rf5", "...Rxh3+", "Re1", "...R8f3+", "Rxe7", "Rc8", "Qxf3", "f5", "Re3", "...a5", "...Bd6", "...Qc5", "Qh4", "Rg6+", "...Qe7", "...exd3", "Rxg8", "Bxg5", "Kb5", "Rb3", "Rxa1", "...Qxh2", "Bf5", "...c5", "Qxe5+", "...Qb5+", "Bxg7+", "Rfd1", "Rc8+", "...Kc3", "Re1", "Kh1", "Qxd2", "Qg3", "...exf4", "...h5", "g4", "Ke5", "...Qg4+", "...Nh3+", "...Qd7", "Rc6", "Rxa7", "Nh2", "Qc2", "...Rxc2+", "Ne4", "Qxe7", "...Qe7", "Rb8", "...Qxg2#", "Qb1", "...Kg8", "...Rf3", "...Qxc2#", "Qe5", "Nd2", "Bxb7", "...Nxd5", "Rd1", "...Qxd5", "...Ng5", "Kf1", "Nc3", "...Rh4+", "Nd5", "Bg8+", "...Rxd2", "...Rb1#", "...Ra5", "...Rc2", "Kh1", "...Ra8", "...Re8", "Qxf8+", "Qd4+", "...Nf4", "...Qh8+", "...Qh4+", "Qxg6+", "Nf3", "Ke3", "...Rd8", "Bxh7+", "Rd3", "...Kb5", "Qf8+", "...Rf3", "...Rc8", "Rd1", "Bxd6+", "Bd2", "Rc1", "Rfxf6+", "Kh2", "...a1=R+", "...Rb1+", "...Qg1+", "a5", "...Kh6", "Ba6", "Qe3", "...Qb4", "...Rh2", "Qxe8+", "...Bh2+", "Bd8", "Rxh5+", "...Qxf1+", "Bxf5+", "Ba6", "Kg2", "Nxh7", "...Kxc8", "...Bxg5+", "...Qxe4", "Kg4", "g4", "Bxe5", "...Re8", "...Qh2#", "Qf6#", "...Kg7", "...Qc6", "...Qf7", "Qa7+", "Rxc8", "Rb3", "...Rab8", "...Kf4", "...f6", "c5", "Ng5", "a3", "...Kh7", "...Rxe1+", "...Bxf3#", "...Kxe6", "Qe8+", "...Rxd4", "Nbd2", "...O-O", "...c5", "...Nxe4", "Kh6", "Bc6", "Qg8+", "...Nc5", "...Bd4", "Nf7", "...Re1+", "...Qxh2+", "Qc5", "...h4", "...Qd8", "Nc5+", "Qg5", "...h6+", "c5", "Rxd7", "Bxa6", "Qxg8+", "...Qh2#", "Bxg7+", "Re8+", "...d4", "Rxe7", "...Bd4+", "...Bd4", "...Rh1", "...Nxf5", "...Bg1+", "...Kg7", "...d5", "Nxf7", "Qg7#", "...Qc5+", "Ra6", "Rxf7", "...Rf4", "Nxe4", "h3", "Bxf6", "Ke3", "Rh8#", "...Bc5+", "...Rh6+", "...Ne3+", "...Qd1+", "Rhf7", "...Bf7", "Rb1", "...Nd5", "...Bxh2+", "...Ng4+", "Bb1", "...b4", "...Qh3", "...Bf7", "...Kxe6", "...Re8", "...Qb6", "Qh5", "...Qh6", "...Kd8", "...Qg5", "...Rc8", "Bg3", "Qh7+", "...Qg2+", "...Rxf1+", "Qxh7+", "...Qe1+", "Rxg6+", "h4", "cxd4", "Qxh5+", "Rd8+", "Kg2", "Bxc5", "...Rc7", "Nxd5", "Re3", "Re1", "g3", "...Re3+", "...Kxc3", "...e5", "Kb4", "...Rxb6", "...g6", "Qd1", "...Nxd4", "Nxd4", "Nh5", "d5", "Qd2", "...fxe3+", "Qg4", "...Re8", "...Bxb3", "...Kh7", "...Bxg2", "R1d4", "...Qc6", "Rb1", "f4", "Rxd8#", "...d5", "...Ra7", "Ba6#", "fxe3", "...Ra8", "...Nd7", "f3", "...Kg8", "Be6+", "...Qxf2+", "Rc8+", "...b6", "...Be4", "Nf7+", "...Bd5", "c6", "...c5", "Qc5", "Qxh7#", "Kg3", "Kf3", "...Qc7", "...Rf1+", "g5", "...Qe1+", "...Kh6", "...Bd5", "Bxf7+", "...f2", "...Ne5", "gxh3", "...Kg6", "Qc7", "...Ra2", "...Kd8", "...Qd3+", "h5", "...a6", "Bf4", "Rg5+", "Kf1", "Rxd6", "...Rh5", "Qxh4#", "...Qxc5", "Bc4+", "Qxf6+", "Bd3", "...Bb6", "...Ne5", "...Rxg2", "...Kd6", "...Qh4", "Nb6", "c4", "Qxg7", "Kh3", "Ra6", "Bd2", "...Rd2", "...Qh2#", "...O-O", "...Rxf7", "Rd1", "Kb5", "Qe8#", "Bg5", "...Nf3+", "...Rxf2", "Ra2", "...bxc4", "...Ra8", "...Qb1+", "Rgxg4+", "...Rxd2", "...Rf8", "Bd1", "Kg2", "Rd1", "...Kxd3", "Nb5", "...Rf4+", "Bb4", "...Re7", "c5", "Rxh3", "...Nd3", "c5", "...Kh4", "Kxc5", "...Nxe2+", "Rb3", "...Rh5", "...Qxf3", "...Ng4", "Rb2", "Bf4", "Ba3", "Rhe1", "...Nb4", "...Bg4", "Rxf6", "Qa5#", "Qe2", "...Rf3+", "...Rh2", "...R1c2+", "Re2", "...Rfg6", "...Ba2", "...b4", "...Qxd5", "...Rh4", "...Rh6+", "...Rbg5", "Qh4", "Be3", "h4", "...Ke3", "...Nd5", "Bxf7+", "Qxh8", "Kg1", "Rxh5", "Qb3", "b3", "...Kc8" };
str Opt3[496] = { "Nh6+", "Bc4", "Qe4+", "...Ng5", "Qg6", "...Bd6", "Qe4+", "...Qb5", "...Qa2", "Ng5", "...Qxd5", "...Qf2#", "b5", "Nb5", "...Na6", "h4", "...Nxd4", "Rf1+", "...Bxg5", "...Rc8", "...Nh7", "...Rxa2", "Qc3", "...e4", "...Qh4", "h3", "Rdd8", "...Ka3", "Rf5", "Rg4", "Nfd2", "h4", "Bf6", "Ka1", "Qe2", "e6", "...Rxa7", "Rg3", "a4", "...g4+", "...Bf8", "...Bxf2+", "Rc1", "...Kh7", "...Qxc2+", "...Re8", "Nc1", "b3", "...Rxd6", "Rf1", "...h4", "...Rxe1", "h5", "...g5", "f5+", "...R3g4", "Rc8+", "...Qxf2+", "...Nxf3", "...Qf6", "Qxh7#", "Qd3#", "Kc4", "...Ke6", "Qxf7+", "Nb4+", "...Rxf1+", "Qg1", "Rg6", "...b6", "Ng3", "Qh5+", "Re6", "h4", "...c3", "Rd2", "...Re6", "Qxe5+", "...g3+", "...Kh4", "...Rd8", "...Bf3", "...Rd8", "Re8+", "Bd3", "...Ra7", "...Ke6", "Qf5", "Qf4+", "Qxe8#", "Bg4", "Kb4", "Re7", "Bb2", "f5", "...Kh7", "Ng5", "...g5", "...Rf8", "...b5", "...Ne3+", "...Kxe8", "...gxf3+", "...Re1+", "...Qxg3+", "...Qxb2", "Nxe5", "Nxf5", "...Bd4+", "a3", "Rxd3", "...d4", "...Bg6", "a3", "...e4+", "Rd1", "...Ke7", "...gxh2+", "...Rh5", "...h5", "Re8+", "...Nxe4", "...Qf4", "Qb6", "...c4", "Qf4+", "Nc5", "g3", "Qh8+", "Red1", "...fxg5#", "...Bb4", "...Qa7", "Qe1", "Rf6", "...Qe5", "...Kd6", "Rxf3", "Rd6", "Rb2", "Rac1", "Ng6+", "...Rxc3", "Bf7", "...Rd1+", "Bxe5+", "...Qb2", "Bf4+", "Rxb7", "Rg8+", "...Kd2", "axb7", "gxf3", "Bb1", "f3", "...cxd2", "...Nb3+", "Rxc6", "c7", "...Rxa2", "...Nxe2+", "...Qxa1+", "Ra8+", "R1a5#", "Qd2", "Qxf6", "...h5", "g4", "Bxd6", "...Qg4#", "exf5", "...Qxf5", "Qb3", "...Qh5#", "...Rxf1#", "...Bg5", "Nc3", "Rf7#", "Qb1", "...Nc5", "g5", "...Qe7", "...hxg6", "Ke1", "Qf3+", "...Rh8", "Re4", "Qd3", "...Rc2", "...Rdc8", "...Rbe5", "...Ra8", "Kf1", "...Ra7", "...e3", "Re2", "Qf3", "...a5", "...Qc7+", "...Qf7", "Re7+", "Qf7+", "Kd3", "...h6", "Kg2", "Rxf7+", "...d4", "Qg8+", "...Rxg3+", "...Qxg5+", "Bxe4", "Rxe7", "Be5", "Qf7+", "h3", "Rf4", "...a1=Q+", "...Qd1+", "...Rad8", "b5+", "...e4", "Bxg8", "c4", "...Qe2", "...Nb3+", "Bxf1", "...Rf8", "Bb6", "Qf6", "...Rbf7", "Qxf5+", "Be4", "Qxe8+", "Nxe4", "...Kc7", "...Rh8+", "...Bxe4", "Kg6", "Rf8", "Kg7", "...f3", "...Rd3", "f5", "...g5", "...Ne3+", "...Qxe5", "Rd1", "Qxd5", "Ng5", "...Qg5", "...Kh4", "...O-O", "g4", "exf7+", "Qd8+", "...Rxg2+", "...Qc5", "...Kh7", "...Rd8#", "Bf5+", "...Nxe4", "Rh3", "...Nf3#", "...Kc5", "...Qb4", "Kf6", "Re8+", "Qh7", "...Qb6", "...Kg7", "Qe2", "...Rab8", "...Rxe4", "Qxf8#", "...Kb3", "...Rf8", "b5", "Rd8+", "...f6+", "Qxe4", "Qxd7+", "Bxd6", "Qxf7#", "...Qf4", "Kg1", "Bxb7", "...Ra8+", "Bd3", "...Qd1+", "...Bg4", "...Rf5#", "...Rxe1+", "...Bxf5", "...Nd7", "...Kh8", "d5+", "Re5", "...Re2", "Kf6", "h4", "...Ra1+", "f5", "h4", "Qe1", "Rd6#", "Rg7", "...Rd8", "...Rh2+", "...Bxd4", "...Qd5", "Ref7", "...Kc3", "Bxb2", "...Bxf2+", "...Ra8", "...Rb8", "Bc4+", "...Nb6", "...Nf3+", "...Kd8", "...Qg3+", "...h2", "...Rac8", "Qxg5", "...e5", "...b4", "...Qc1+", "...Bd3", "Qe3", "Ne4", "...Rxd5", "...Ba6", "Rxe8+", "...Ng5", "Rb8", "h3", "Rxd4", "Kf2", "fxe3", "Qd4+", "Qe2", "...Rxa4", "exd6", "Qd8#", "Bc7", "g4", "...Nc5+", "...Kxa3", "...Kf7", "e5", "...Qa2", "...a6", "e4", "...Nxe4", "h3", "Qg5", "Nc2", "Qe7", "...Qxg3+", "Qxd4", "...Kg8", "...Bxe3", "...Rab8", "...a3", "Kh2", "...Rxe2", "O-O", "Nf3", "Rd3", "...Kg8", "...Bd6", "Bc4", "Qh7#", "...d4", "...Bxc3", "g3", "...hxg5", "Qe6#", "...h6", "Rc7", "...Kxe7", "...Kg6", "Qf4", "...b5", "Rxb7", "...b5", "Qe4+", "Rxg8+", "Kg2", "Kg2", "...Rg1+", "...Qxg2+", "a5", "...Kg7", "...Rb4+", "...a6", "Rd7", "...g5", "...Qe8", "g3", "...hxg3", "Qf6", "...b2", "...Nxe4", "...Qd6", "Rd6", "...Kb8", "Ne7+", "Rxf3+", "Nh6+", "Rd8+", "...Rxg4", "Qf3", "...Rge8", "Bxh7+", "Qh5+", "Bd5+", "...Rf6", "...Rhe8", "...Nfg4+", "...Kd7", "...Qh5", "Qxf5+", "f6+", "Ra1", "Kg3", "Qa5", "Be3", "...Rd4+", "...Be6", "...d5", "...Rde8", "Ra8+", "Ra1", "Qg3", "Rxe5", "...Ne4", "...Rd1+", "Rd2+", "...Nxh5", "...Rbxd8", "...Kh7", "Rf4", "...Ne3", "...a5", "Nxd4", "Rd5+", "Bh7+", "...Kxd4", "Qxg6+", "...Rg1", "b4", "...Re4", "Nh6+", "c3", "...a6", "Raf2", "...Rd8", "a5", "...Rxe2", "Ra2", "...Be2", "...Qe6", "...Rc8", "Rb8+", "Be3", "Bc1", "Qg3", "...Qa5+", "...Rg5", "Rh4", "Kf3", "Qg2", "...Qd2", "...Rh1+", "...R6c3", "Qh6+", "...Rf7", "...a2", "...Qb6+", "...exd4", "...Nf4+", "...Be7", "...Rf5", "Qh7#", "Re1", "Qc2", "...Be3", "...Nh5", "g4", "Qxg6#", "Rxh5#", "Qg4+", "Qd1", "Ke5", "...Kc6" };
int Correct[496]  = { 3, 2, 1, 1, 1, 1, 2, 1, 2, 1, 3, 3, 2, 1, 1, 1, 1, 3, 3, 1, 1, 1, 1, 3, 3, 1, 3, 2, 3, 2, 1, 2, 2, 3, 2, 1, 3, 1, 2, 3, 1, 3, 3, 1, 3, 1, 1, 2, 2, 1, 1, 3, 2, 2, 1, 2, 3, 3, 3, 3, 3, 3, 2, 1, 1, 3, 3, 2, 1, 1, 2, 3, 3, 3, 1, 2, 1, 1, 3, 2, 2, 2, 2, 3, 2, 2, 2, 1, 3, 3, 1, 1, 1, 2, 3, 2, 3, 2, 2, 1, 3, 2, 3, 3, 3, 1, 3, 1, 3, 1, 1, 2, 1, 1, 2, 2, 2, 3, 2, 2, 3, 1, 2, 2, 2, 1, 1, 2, 3, 1, 3, 1, 1, 2, 2, 1, 2, 2, 1, 1, 1, 3, 1, 3, 3, 3, 1, 2, 3, 2, 2, 3, 3, 2, 1, 3, 3, 3, 3, 2, 3, 3, 3, 3, 2, 1, 2, 1, 1, 3, 3, 2, 1, 3, 3, 2, 3, 3, 2, 1, 1, 2, 3, 1, 3, 2, 1, 2, 2, 2, 3, 3, 2, 1, 1, 2, 2, 2, 2, 2, 3, 3, 1, 1, 2, 1, 2, 1, 3, 3, 1, 2, 1, 3, 1, 1, 3, 2, 2, 1, 1, 3, 1, 2, 2, 1, 2, 1, 2, 2, 2, 1, 3, 1, 1, 3, 2, 1, 2, 2, 3, 2, 2, 1, 1, 3, 2, 2, 1, 1, 2, 3, 1, 1, 3, 3, 2, 2, 3, 2, 2, 1, 3, 1, 1, 3, 3, 1, 1, 1, 2, 2, 2, 3, 1, 1, 3, 3, 2, 3, 3, 1, 3, 2, 1, 2, 3, 1, 3, 3, 3, 3, 1, 2, 1, 1, 2, 2, 1, 1, 3, 2, 1, 2, 3, 2, 2, 2, 2, 2, 1, 1, 2, 3, 2, 2, 3, 1, 3, 2, 3, 3, 1, 1, 1, 1, 3, 1, 1, 2, 2, 1, 3, 2, 2, 1, 3, 3, 2, 3, 1, 3, 2, 3, 1, 1, 3, 3, 3, 1, 1, 1, 3, 3, 1, 2, 2, 1, 3, 3, 2, 3, 3, 2, 1, 3, 1, 2, 2, 1, 3, 2, 3, 2, 1, 1, 1, 3, 2, 2, 1, 2, 2, 1, 1, 1, 3, 2, 1, 1, 3, 3, 2, 2, 2, 1, 1, 1, 2, 2, 3, 3, 3, 3, 1, 2, 1, 3, 2, 3, 3, 3, 2, 1, 2, 2, 3, 1, 2, 3, 1, 1, 3, 3, 1, 1, 3, 1, 3, 2, 1, 2, 3, 1, 2, 3, 2, 3, 1, 2, 1, 2, 1, 2, 1, 3, 3, 3, 1, 3, 2, 2, 1, 3, 2, 2, 1, 3, 3, 2, 1, 1, 2, 1, 3, 1, 1, 1, 2, 1, 1, 2, 3, 3, 3, 1, 3, 2, 3, 2, 3, 3, 2, 1, 3, 1, 1, 3, 1, 2, 3, 3, 1, 3, 1, 1 };

// 496 puzzles are in the hardcoded database
function int RandPuzzleIndex(void) { return Random(0, 496); }

script 9000 OPEN { // Initialize per-player variables on map load
    int i;
    for (i = 0; i < MAX_PLAYERS; i++) {
        curPuzzle[i] = -1;
        chess_board_showing[i] = 0;
    }
}

function void DrawPuzzleHud(int idx) { // Board image
	SetFont(BoardImg[idx]);
	HudMessage(
		s:"A";                   
		HUDMSG_PLAIN, HUD_BOARD_ID, CR_UNTRANSLATED,
		0.5, 0.42, 10000.0
	);

	// Text under the board
	SetFont("SmallFont");
	HudMessage(
		s: StrParam(
			s:"\n\n\n\n\n\n\n\n\nlichess puzzleID: ", s:BoardImg[idx], s:"\n",
			s:"1) ", s:Opt1[idx], s:"\n",
			s:"2) ", s:Opt2[idx], s:"\n",
			s:"3) ", s:Opt3[idx], s:"\n",
			s:"(press Q to answer)"
		);
		HUDMSG_PLAIN, HUD_TEXT_ID, CR_GOLD,
		0.5, 0.82, 10000.0
	);
}

// ---- The new pickup-trigger script ----
//script 903 (void)
//{
//    int p = PlayerNumber();

    // If a puzzle is already on-screen, don't stack another
//    if (chess_board_showing[p]) { terminate; }

    // Pick a puzzle if none is active
//    if (curPuzzle[p] < 0) { curPuzzle[p] = RandPuzzleIndex(); }

//	chess_board_showing[p] = 1;
//	DrawPuzzleHud(curPuzzle[p]);
//	SetPlayerProperty(0, 1, PROP_TOTALLYFROZEN);
//}

function void ClearPuzzleHud(void)
{
    HudMessage(s:""; HUDMSG_PLAIN, HUD_BOARD_ID, CR_UNTRANSLATED, 0.5, 0.42, 0.05);
    HudMessage(s:""; HUDMSG_PLAIN, HUD_TEXT_ID,  CR_UNTRANSLATED, 0.5, 0.82, 0.05);
}

// Toggle board overlay + freeze/unfreeze
script 902 (void)
{
    int p = PlayerNumber();

    if (!chess_board_showing[p]) {  // show board
        chess_board_showing[p] = 1;
        if (curPuzzle[p] < 0) { curPuzzle[p] = RandPuzzleIndex(); }
        DrawPuzzleHud(curPuzzle[p]);
        SetPlayerProperty(0, 1, PROP_TOTALLYFROZEN);
    } else {                        // unshow board
        chess_board_showing[p] = 0;
        ClearPuzzleHud();
        SetPlayerProperty(0, 0, PROP_TOTALLYFROZEN);
		curPuzzle[p] = -1;  
    }
}

// Called when the player enters Pain (took damage) not used in the current mod
//script "ToggleChessOnDamage" (void)
//{
//    int p = PlayerNumber();
//    int now = Timer();                         // tics since map start (35 tics/sec)
//    if (now - lastDmgTic[p] < 35*2) terminate; // 2s cooldown so rapid hits donâ€™t spam puzzles
//    lastDmgTic[p] = now;
//    ACS_ExecuteAlways(902, 0);
//}

script "ShowChessOnKill" (void)
{
    // Ensure the activator is the player who killed the monster
    // If the monster had no valid target (barrel/splash), fall back to console player.
    if (!SetActivatorToTarget(0))
    {
        // make the local player the activator
        SetActivator(0); // 0 = console player in single-player
    }

    int p = PlayerNumber();
    if (p < 0) terminate;  // still no player? bail out safely

    // Small cooldown to avoid double-fire (Death and XDeath or multiple deaths same tic)
    static int lastTic[MAX_PLAYERS];
    int now = Timer();
    if (now - lastTic[p] < 10) terminate;  // ~0.3s
    lastTic[p] = now;

    // SHOW ONLY (do NOT toggle off here)
    if (!chess_board_showing[p])
    {
        chess_board_showing[p] = 1;
        if (curPuzzle[p] < 0) curPuzzle[p] = RandPuzzleIndex();
        DrawPuzzleHud(curPuzzle[p]);
        SetPlayerProperty(0, 1, PROP_TOTALLYFROZEN);
    }
}

script "HideChess" (void) // a clean closer you can call after answering
{
    if (PlayerNumber() < 0) terminate;
    int p = PlayerNumber();

    if (chess_board_showing[p])
    {
        chess_board_showing[p] = 0;
        ClearPuzzleHud();
        SetPlayerProperty(0, 0, PROP_TOTALLYFROZEN);
        curPuzzle[p] = -1;
    }
}

// grader
script 1 (int choice)
{
    int p = PlayerNumber();
    int idx = curPuzzle[p];

    if (idx < 0) {
        Print(s:"No active puzzle.");
        terminate;
    }

    if (choice == Correct[idx]) {
        GiveInventory("HealthBonus", 1);
        Print(s:"Correct! +1 health.");
    } else {
        Thing_Damage(0, 5);
        Print(s:"Wrong! -5 HP.");
    }
}
